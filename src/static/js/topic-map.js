var CommunityDiscussions = CommunityDiscussions || {};

(function(CD) {
  CD.initFormMap = function(options) {
        // Generated by the form
    var $input = $('#id_place'),
        // Defined in _post_form_map.html
        $centerpoint = $('#centerpoint'),
        map = new L.Map(options.el, {
          scrollWheelZoom: false,
          dragging: options.editable,
          doubleClickZoom: options.editable,
          boxZoom: options.editable,
          touchZoom: options.editable
        }),
        layer = new L.TileLayer(options.tileUrl, {maxZoom: 17, attribution: options.tileAttribution});

    map.setView(options.center, 14).addLayer(layer);

    if (options.editable){
      setPlace(map.getCenter());

      map.on('move', function(evt) {
        setPlace(map.getCenter());
      });

      map.on('movestart', function() {
        $centerpoint.addClass('dragging');
      });

      map.on('moveend', function() {
        $centerpoint.removeClass('dragging');
      });
    }

    function setPlace(latLng) {
      var wkt = 'POINT ('+ latLng.lng +' '+ latLng.lat +')';
      $input.val(wkt);
    }
  };
})(CommunityDiscussions);